name: Build and Deploy to GCP

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GCP_HOST: ${{ secrets.GCP_HOST }}
      GCP_USERNAME: ${{ secrets.GCP_USERNAME }}
      GCP_SSH_KEY: ${{ secrets.GCP_SSH_KEY }}
      ENV_FILE: ${{ secrets.ENV_FILE }}

    steps:
      - uses: actions/checkout@v3

      - name: Verify Secrets
        run: |
          if [ -z "$GCP_HOST" ] || [ -z "$GCP_USERNAME" ] || [ -z "$GCP_SSH_KEY" ]; then
            echo "âŒ Required secrets are missing in GitHub Settings."
            exit 1
          fi

      - name: Create .env
        run: echo "$ENV_FILE" > .env

      - name: Pack Application
        run: tar -czf deploy.tar.gz --exclude='node_modules' --exclude='*/node_modules' --exclude='.git' Backend nginx docker-compose.prod.yml package.json schema.sql init_auth.sql Dockerfile .env DEPLOYMENT_GUIDE.md SECURITY.md

      - name: Stop & Clean Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.GCP_HOST }}
          username: ${{ env.GCP_USERNAME }}
          key: ${{ env.GCP_SSH_KEY }}
          script: |
            mkdir -p ~/medmitra
            sudo docker ps -aq --filter name=medmitra | xargs -r sudo docker rm -f || true
            sudo docker system prune -af || true
            sudo rm -rf ~/medmitra/*

      - name: Upload Application
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.GCP_HOST }}
          username: ${{ env.GCP_USERNAME }}
          key: ${{ env.GCP_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "~/medmitra"

      - name: Extract & Launch
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.GCP_HOST }}
          username: ${{ env.GCP_USERNAME }}
          key: ${{ env.GCP_SSH_KEY }}
          script: |
            cd ~/medmitra
            tar -xzf deploy.tar.gz
            # Create Nginx Config
            printf "server {\n    listen 80;\n    server_name 136-116-93-95.sslip.io;\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen 443 ssl;\n    server_name 136-116-93-95.sslip.io;\n\n    ssl_certificate /etc/letsencrypt/live/136-116-93-95.sslip.io/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/136-116-93-95.sslip.io/privkey.pem;\n\n    location / {\n        proxy_pass http://localhost:3000;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n" > medmitra_site.conf
            sudo cp medmitra_site.conf /etc/nginx/sites-available/medmitra
            sudo ln -sf /etc/nginx/sites-available/medmitra /etc/nginx/sites-enabled/medmitra
            sudo nginx -t && sudo systemctl restart nginx
            # Start Containers
            sudo docker-compose -f docker-compose.prod.yml up --build -d

