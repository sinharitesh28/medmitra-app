name: Build and Deploy to GCP

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GCP_HOST: ${{ secrets.GCP_HOST }}
      GCP_USERNAME: ${{ secrets.GCP_USERNAME }}
      GCP_SSH_KEY: ${{ secrets.GCP_SSH_KEY }}
      ENV_FILE: ${{ secrets.ENV_FILE }}

    steps:
      - uses: actions/checkout@v3

      - name: Verify Secrets
        run: |
          if [ -z "$GCP_HOST" ] || [ -z "$GCP_USERNAME" ] || [ -z "$GCP_SSH_KEY" ]; then
            echo "âŒ Required secrets are missing in GitHub Settings."
            exit 1
          fi

      - name: Create .env
        run: echo "$ENV_FILE" > .env

      - name: Pack Application
        run: tar -czf deploy.tar.gz --exclude='node_modules' --exclude='*/node_modules' --exclude='.git' Backend Pages Scripts Styles nginx docker-compose.prod.yml package.json schema.sql init_auth.sql Dockerfile index.js .env DEPLOYMENT_GUIDE.md SECURITY.md

      - name: Stop & Clean Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.GCP_HOST }}
          username: ${{ env.GCP_USERNAME }}
          key: ${{ env.GCP_SSH_KEY }}
          script: |
            mkdir -p ~/medmitra
            sudo -n docker-compose -f ~/medmitra/docker-compose.prod.yml down || true
            sudo -n docker ps -aq --filter name=medmitra | xargs -r sudo -n docker rm -f || true
            sudo -n docker system prune -af --volumes || true
            rm -rf ~/medmitra/*

      - name: Upload Application
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.GCP_HOST }}
          username: ${{ env.GCP_USERNAME }}
          key: ${{ env.GCP_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "~/medmitra"

      - name: Extract & Launch
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.GCP_HOST }}
          username: ${{ env.GCP_USERNAME }}
          key: ${{ env.GCP_SSH_KEY }}
          script: |
            set -e
            cd ~/medmitra
            tar -xzf deploy.tar.gz
            
            # Create Nginx Config (Using 127.0.0.1 instead of localhost for stability)
            cat << 'EOF' > medmitra_site.conf
            server {
                listen 80;
                server_name 136-116-93-95.sslip.io;
                return 301 https://$host$request_uri;
            }

            server {
                listen 443 ssl;
                server_name 136-116-93-95.sslip.io;

                ssl_certificate /etc/letsencrypt/live/136-116-93-95.sslip.io/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/136-116-93-95.sslip.io/privkey.pem;

                location / {
                    proxy_pass http://127.0.0.1:3000;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_connect_timeout 60s;
                    proxy_read_timeout 60s;
                }
            }
            EOF
            
            # Remove default config if exists
            sudo -n rm -f /etc/nginx/sites-enabled/default
            sudo -n cp medmitra_site.conf /etc/nginx/sites-available/medmitra
            sudo -n ln -sf /etc/nginx/sites-available/medmitra /etc/nginx/sites-enabled/medmitra
            sudo -n nginx -t && sudo -n systemctl restart nginx
            
            # Start Containers
            sudo -n docker-compose -f docker-compose.prod.yml up --build -d
            
            echo "Waiting for startup..."
            sleep 10
            sudo -n docker ps
            echo "--- APP LOGS ---"
            sudo -n docker logs medmitra_app --tail 50