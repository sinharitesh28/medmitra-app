<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedMitra - Admin Dashboard</title>
    <script src="../Scripts/auth-guard.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="../Styles/medmitra.css">
    <style>
        .admin-section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .admin-section h3 { margin-top: 0; border-bottom: 2px solid #f4f4f9; padding-bottom: 10px; }
        .user-table { width: 100%; border-collapse: collapse; }
        .user-table th, .user-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .role-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .role-SUPER_ADMIN { background-color: #6610f2; color: white; }
        .role-ADMIN { background-color: #007bff; color: white; }
        .role-STAFF { background-color: #6c757d; color: white; }
        
        .qr-box { display: flex; align-items: center; gap: 20px; background: #e9ecef; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <a href="/index.html" class="back-link">&larr;</a>
            <h1>MedMitra Admin</h1>
        </div>
        <div id="user-profile" class="header-right">Loading...</div>
    </header>

    <nav class="medmitra-nav">
        <a href="/medmitra/registration.html">Registration</a>
        <a href="/medmitra/assigned.html">Assigned</a>
        <a href="/medmitra/reminders.html">Reminders</a>
        <a href="/medmitra/statistics.html">Statistics</a>
        <a href="/medmitra/inactive.html">Inactive</a>
        <a href="/medmitra/alerts.html">Alerts</a>
        <a href="/medmitra/admin_dashboard.html" class="active">Admin Panel</a>
    </nav>

    <div class="container">
        <!-- User Management -->
        <div class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>üë• User Management</h3>
                <button onclick="openModal()" style="background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">+ Add User</button>
            </div>
            <table class="user-table" id="usersTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Telegram</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6">Loading users...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- User Add/Edit Modal -->
    <div id="userModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 2rem; border-radius: 8px; width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
            <h2 id="modalTitle">Add User</h2>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Full Name</label>
                    <input type="text" id="userName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Email</label>
                    <input type="email" id="userEmail" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="userIsAdmin" style="width: 20px; height: 20px;">
                    <label for="userIsAdmin"><strong>Grant Admin Privileges?</strong></label>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeModal()" style="padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                    <button type="submit" style="padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Link Telegram Modal -->
    <div id="linkModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 2rem; border-radius: 8px; width: 350px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
            <h3>üì± Link Telegram</h3>
            <p id="linkTargetUser" style="color: #666; margin-bottom: 15px;">Scanning...</p>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; display: inline-block;">
                <div id="link-qr"></div>
            </div>
            
            <p style="margin-top: 15px; font-size: 0.9rem;">Ask the user to scan this code.</p>
            <button onclick="document.getElementById('linkModal').style.display='none'" style="margin-top: 10px; padding: 8px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
    </div>

    <script>
        let botUsername = '';

        // 1. Fetch Bot Info on Load
        fetch('/api/medmitra/bot-info')
            .then(r => r.json())
            .then(data => botUsername = data.username);

        // 2. Fetch Users
        async function fetchUsers() {
            try {
                const res = await fetch('/api/admin/users');
                if (!res.ok) throw new Error('Unauthorized');
                const users = await res.json();
                
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = users.map(u => `
                    <tr style="opacity: ${u.status === 'INACTIVE' ? '0.5' : '1'}">
                        <td>${u.name || '-'}</td>
                        <td>${u.email}</td>
                        <td><span class="role-badge role-${u.role}">${u.role}</span></td>
                        <td>
                            ${u.telegram_chat_id 
                                ? '<span style="color: green; font-weight: bold;">‚úÖ Linked</span>' 
                                : `<button onclick="openLinkModal(${u.user_id}, '${u.name}')" style="background: none; border: 1px solid #007bff; color: #007bff; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem;">üîó Link Now</button>`
                            }
                        </td>
                        <td>${u.status}</td>
                        <td>
                            <button onclick='openModal(${JSON.stringify(u)})' style="padding: 4px 8px; cursor: pointer;">‚úèÔ∏è Edit</button>
                            ${u.role !== 'SUPER_ADMIN' ? 
                                `<button onclick="toggleUser(${u.user_id})" style="padding: 4px 8px; cursor: pointer; color: ${u.status === 'ACTIVE' ? 'red' : 'green'}; margin-left: 5px;">
                                    ${u.status === 'ACTIVE' ? '‚ùå Disable' : '‚úÖ Enable'}
                                </button>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        // 3. User Modal Logic
        const modal = document.getElementById('userModal');
        const form = document.getElementById('userForm');

        function openModal(user = null) {
            modal.style.display = 'flex';
            if (user) {
                document.getElementById('modalTitle').textContent = 'Edit User';
                document.getElementById('userId').value = user.user_id;
                document.getElementById('userName').value = user.name;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userIsAdmin').checked = (user.role === 'ADMIN' || user.role === 'SUPER_ADMIN');
            } else {
                document.getElementById('modalTitle').textContent = 'Add User';
                form.reset();
                document.getElementById('userId').value = '';
            }
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        // 4. Link Telegram Logic
        function openLinkModal(userId, name) {
            const linkModal = document.getElementById('linkModal');
            const qrContainer = document.getElementById('link-qr');
            document.getElementById('linkTargetUser').textContent = `Generate link for: ${name}`;
            
            qrContainer.innerHTML = ''; // Clear previous
            
            if (botUsername) {
                const link = `https://t.me/${botUsername}?start=ADMIN_LINK_${userId}`;
                new QRCode(qrContainer, {
                    text: link,
                    width: 150,
                    height: 150
                });
                linkModal.style.display = 'flex';
            } else {
                alert('Bot not ready. Try refreshing.');
            }
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('userId').value;
            const data = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                isAdmin: document.getElementById('userIsAdmin').checked
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/admin/users/${id}` : '/api/admin/users';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    closeModal();
                    fetchUsers();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Operation failed');
                }
            } catch (err) {
                alert('Network error');
            }
        };

        async function toggleUser(id) {
            if (!confirm('Change status for this user?')) return;
            try {
                const res = await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
                if (res.ok) fetchUsers();
                else alert('Failed to change status');
            } catch (e) { alert('Error'); }
        }

        fetchUsers();
    </script>
</body>
</html>