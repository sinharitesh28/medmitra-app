<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedMitra - Registration</title>
    <script src="../Scripts/auth-guard.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="../Scripts/config.js"></script>
    <script src="../Scripts/i18n.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { primary: '#1B211A', secondary: '#628141', tertiary: '#8BAE66', quaternary: '#EBD5AB' }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .suggestions-list::-webkit-scrollbar { width: 5px; }
        .suggestions-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-primary text-gray-300 w-64 flex-shrink-0 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-50 flex flex-col shadow-2xl">
            <div class="h-20 flex items-center justify-center border-b border-gray-800/50 bg-primary/50 backdrop-blur-sm">
                <h1 class="text-2xl font-bold tracking-widest text-quaternary flex items-center gap-3">
                    <span class="text-3xl">‚öïÔ∏è</span> MedMitra
                </h1>
            </div>
            <nav class="flex-1 px-4 py-8 space-y-2 overflow-y-auto no-scrollbar">
                <a href="/medmitra/registration.html" class="nav-link flex items-center px-4 py-3.5 rounded-xl transition-all duration-200 hover:bg-white/5 hover:text-white group">
                    <span class="text-xl mr-3 opacity-70 group-hover:opacity-100 transition-opacity">üìù</span><span class="font-medium tracking-wide">Registration</span>
                </a>
                <a href="/medmitra/assigned.html" class="nav-link flex items-center px-4 py-3.5 rounded-xl transition-all duration-200 hover:bg-white/5 hover:text-white group">
                    <span class="text-xl mr-3 opacity-70 group-hover:opacity-100 transition-opacity">üìÖ</span><span class="font-medium tracking-wide">Assigned</span>
                </a>
                <a href="/medmitra/reminders.html" class="nav-link flex items-center px-4 py-3.5 rounded-xl transition-all duration-200 hover:bg-white/5 hover:text-white group">
                    <span class="text-xl mr-3 opacity-70 group-hover:opacity-100 transition-opacity">üîî</span><span class="font-medium tracking-wide">Reminders</span>
                </a>
                <a href="/medmitra/statistics.html" class="nav-link flex items-center px-4 py-3.5 rounded-xl transition-all duration-200 hover:bg-white/5 hover:text-white group">
                    <span class="text-xl mr-3 opacity-70 group-hover:opacity-100 transition-opacity">üìä</span><span class="font-medium tracking-wide">Statistics</span>
                </a>
                <a href="/medmitra/inactive.html" class="nav-link flex items-center px-4 py-3.5 rounded-xl transition-all duration-200 hover:bg-white/5 hover:text-white group">
                    <span class="text-xl mr-3 opacity-70 group-hover:opacity-100 transition-opacity">‚ö†Ô∏è</span><span class="font-medium tracking-wide">Inactive</span>
                </a>
                <a href="/medmitra/alerts.html" class="nav-link flex items-center px-4 py-3.5 rounded-xl transition-all duration-200 hover:bg-white/5 hover:text-white group">
                    <span class="text-xl mr-3 opacity-70 group-hover:opacity-100 transition-opacity">üö®</span><span class="font-medium tracking-wide">Alerts</span>
                </a>
                <div class="my-4 border-t border-gray-800/50"></div>
                <a href="/medmitra/admin_dashboard.html" class="nav-link flex items-center px-4 py-3.5 rounded-xl transition-all duration-200 hover:bg-white/5 hover:text-white group">
                    <span class="text-xl mr-3 opacity-70 group-hover:opacity-100 transition-opacity">‚öôÔ∏è</span><span class="font-medium tracking-wide">Admin</span>
                </a>
            </nav>
            <div class="p-6 border-t border-gray-800/50">
                <button onclick="logout()" class="w-full flex items-center justify-center px-4 py-3 bg-red-500/10 text-red-400 hover:bg-red-600 hover:text-white rounded-xl transition-all duration-200 text-sm font-semibold tracking-wide border border-transparent hover:border-red-500 shadow-sm">Sign Out</button>
            </div>
        </aside>

        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-primary/80 backdrop-blur-sm z-40 hidden md:hidden transition-opacity"></div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col min-w-0 overflow-hidden bg-[#F3F4F6]">
            <header class="bg-white/90 backdrop-blur-md border-b border-gray-200 h-20 flex items-center justify-between px-8 sticky top-0 z-30 shadow-sm">
                <div class="flex items-center">
                    <button onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-primary focus:outline-none p-2 mr-4 transition-colors">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 tracking-tight" id="page-title">New Patient Registration</h2>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-4 md:p-10 space-y-8 scroll-smooth">
                <div class="max-w-5xl mx-auto">
                    <form id="medMitraForm" class="space-y-8">
                        <!-- Patient Details -->
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 relative group hover:shadow-md transition-shadow">
                            <div class="absolute top-0 left-0 w-1.5 h-full bg-secondary"></div>
                            <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center gap-2">
                                <span class="bg-secondary/10 p-2 rounded-lg text-secondary">üë§</span> Patient Details
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">OPD Number</label>
                                    <input type="text" id="opdNo" required class="block w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-secondary/20 focus:border-secondary transition-all">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Full Name</label>
                                    <input type="text" id="patientName" required class="block w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-secondary/20 focus:border-secondary transition-all">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Contact Number</label>
                                    <input type="text" id="contactNumber" required class="block w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-secondary/20 focus:border-secondary transition-all">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Reminder Language</label>
                                    <select id="language" class="block w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-secondary/20 focus:border-secondary transition-all appearance-none">
                                        <option value="en">English</option>
                                        <option value="hi">Hindi</option>
                                        <option value="gu">Gujarati</option>
                                        <option value="bn">Bengali</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Diagnosis -->
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 relative group">
                             <div class="absolute top-0 left-0 w-1.5 h-full bg-quaternary"></div>
                             <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center gap-2">ü©∫ Clinical Info</h3>
                             <div class="space-y-6">
                                <div class="relative">
                                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Chief Complaint</label>
                                    <input type="text" id="complaint" onkeyup="searchICD(this, 'complaint-list', 'complaintCode')" autocomplete="off" class="block w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-secondary/20 focus:border-secondary transition-all">
                                    <input type="hidden" id="complaintCode">
                                    <ul id="complaint-list" class="suggestions-list absolute z-50 w-full bg-white border border-gray-200 rounded-xl mt-2 shadow-xl max-h-60 overflow-y-auto hidden"></ul>
                                </div>
                                <div class="relative">
                                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Confirmed Diagnosis</label>
                                    <input type="text" id="diagnosis" onkeyup="searchICD(this, 'diagnosis-list', 'diagnosisCode')" autocomplete="off" class="block w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-secondary/20 focus:border-secondary transition-all">
                                    <input type="hidden" id="diagnosisCode">
                                    <ul id="diagnosis-list" class="suggestions-list absolute z-50 w-full bg-white border border-gray-200 rounded-xl mt-2 shadow-xl max-h-60 overflow-y-auto hidden"></ul>
                                </div>
                             </div>
                        </div>

                        <!-- Therapy -->
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 relative group overflow-visible">
                             <div class="absolute top-0 left-0 w-1.5 h-full bg-tertiary"></div>
                             <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">üíä Therapy Regimen</h3>
                                <button type="button" onclick="addTherapyRow()" class="px-4 py-2 bg-secondary/10 text-secondary border border-secondary/20 rounded-lg text-sm font-bold transition-all">+ Add Drug</button>
                            </div>
                            <div class="overflow-x-auto rounded-xl border border-gray-200">
                                <table id="therapyTable" class="w-full text-left border-collapse min-w-[700px]">
                                    <thead>
                                        <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider font-semibold border-b border-gray-200">
                                            <th class="px-5 py-4">Drug Name</th>
                                            <th class="px-5 py-4">Dose</th>
                                            <th class="px-5 py-4">Schedule</th>
                                            <th class="px-5 py-4">End Date</th>
                                            <th class="px-5 py-4 text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100 bg-white"></tbody>
                                </table>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-primary text-quaternary font-bold py-4 rounded-xl shadow-lg hover:shadow-2xl transition-all transform hover:-translate-y-0.5 tracking-wide text-lg">Generate QR & Register</button>
                    </form>

                    <div id="message" class="hidden mt-8 p-6 rounded-xl text-center text-sm font-bold border fade-in"></div>

                    <div id="qr-container" class="hidden mt-10 text-center bg-white p-10 rounded-3xl border border-gray-100 shadow-xl fade-in relative overflow-hidden">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Scan to Activate</h3>
                        <div class="flex justify-center mb-8"><div id="qrcode" class="p-6 bg-white rounded-2xl shadow-lg border border-gray-100 relative z-10"></div></div>
                        <div id="status-text" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-secondary/10 text-secondary font-bold animate-pulse">Waiting for patient consent...</div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }
        function logout() { window.location.href = '/Pages/login.html'; }

        /* --- Application Logic --- */
        let pollingInterval = null;
        let rowCount = 0;
        const botUsername = CONFIG.BOT_USERNAME;

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        const searchICD = debounce(async (input, listId, codeId) => {
            const term = input.value;
            const list = document.getElementById(listId);
            if (term.length < 3) { list.classList.add('hidden'); return; }
            try {
                const res = await fetch(`${CONFIG.API_BASE_URL}/api/medmitra/icd/search?q=${encodeURIComponent(term)}`);
                const data = await res.json();
                if (data.length > 0) {
                    list.innerHTML = data.map(item => `<li onclick="selectICD('${item.title}', '${item.code}', '${listId}', '${input.id}', '${codeId}')" class="px-5 py-3 hover:bg-gray-50 cursor-pointer text-sm border-b border-gray-100 last:border-none"><div>${item.title}</div><div class="text-xs text-gray-400 font-mono">${item.code}</div></li>`).join('');
                    list.classList.remove('hidden');
                } else { list.classList.add('hidden'); }
            } catch (e) { console.error(e); }
        }, 400);

        const searchDrug = debounce(async (input, id) => {
            const term = input.value;
            const list = document.getElementById(`suggestions-${id}`);
            if (term.length < 2) { list.classList.add('hidden'); return; }
            try {
                const [localRes, globalRes] = await Promise.all([
                    fetch(`${CONFIG.API_BASE_URL}/api/medmitra/rxnorm/formulary?q=${encodeURIComponent(term)}`),
                    fetch(`${CONFIG.API_BASE_URL}/api/medmitra/rxnorm/search?q=${encodeURIComponent(term)}`)
                ]);
                const localData = await localRes.json();
                const globalData = await globalRes.json();
                const results = [...localData.map(d => ({ ...d, source: 'Formulary' })), ...globalData.filter(g => !localData.some(l => l.rxcui === g.rxcui)).map(d => ({ ...d, source: 'Global' }))].slice(0, 10);
                if (results.length > 0) {
                    list.innerHTML = results.map(d => `<li onclick="selectDrug(this, ${id}, '${d.drug_name}', '${d.rxcui}', '${d.brand_name || ''}')" class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-none flex justify-between items-center"><div class="text-sm"><b>${d.drug_name}</b><br><small>${d.brand_name}</small></div><span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded-md ${d.source === 'Formulary' ? 'bg-secondary/10 text-secondary' : 'bg-gray-100 text-gray-500'}">${d.source}</span></li>`).join('');
                    list.classList.remove('hidden');
                } else { list.classList.add('hidden'); }
            } catch (e) { console.error(e); }
        }, 300);

        function selectICD(title, code, listId, inputId, codeId) {
            document.getElementById(inputId).value = title;
            document.getElementById(codeId).value = code;
            document.getElementById(listId).classList.add('hidden');
        }

        function addTherapyRow() {
            const table = document.getElementById('therapyTable').getElementsByTagName('tbody')[0];
            const row = table.insertRow();
            const id = rowCount++;
            row.className = "hover:bg-gray-50/50 transition-colors group animate-[fadeIn_0.3s_ease-in-out]";
            row.innerHTML = `<td class="px-5 py-3 relative align-top"><input type="text" placeholder="Drug..." onkeyup="searchDrug(this, ${id})" autocomplete="off" required class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-secondary/20 focus:border-secondary text-sm"><ul id="suggestions-${id}" class="suggestions-list absolute z-50 w-full bg-white border border-gray-200 rounded-xl mt-1 shadow-2xl max-h-48 overflow-y-auto hidden left-0 ring-1 ring-black/5"></ul><input type="hidden" class="rxcui-hidden"></td><td class="px-5 py-3 align-top"><input list="doses-${id}" type="text" placeholder="500mg" required class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-secondary/20 focus:border-secondary text-sm"><datalist id="doses-${id}"></datalist></td><td class="px-5 py-3 align-top"><input type="text" placeholder="09:00, 21:00" required class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-secondary/20 focus:border-secondary text-sm"></td><td class="px-5 py-3 align-top"><input type="date" required class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-secondary/20 focus:border-secondary text-sm"></td><td class="px-5 py-3 text-center align-top pt-4"><button type="button" onclick="this.closest('tr').remove()" class="text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"></path></svg></button></td>`;
        }

        async function selectDrug(li, id, name, rxcui, brand) {
            const row = li.closest('td');
            const input = row.querySelector('input[type="text"]');
            const hidden = row.querySelector('.rxcui-hidden');
            const list = row.querySelector('ul');
            const doseList = document.getElementById(`doses-${id}`);
            input.value = name + (brand ? ` (${brand})` : '');
            hidden.value = rxcui;
            list.classList.add('hidden');
            try {
                const res = await fetch(`${CONFIG.API_BASE_URL}/api/medmitra/rxnorm/details/${rxcui}`);
                const data = await res.json();
                if (data.available_doses) doseList.innerHTML = data.available_doses.map(d => `<option value="${d}">`).join('');
            } catch (e) { console.error(e); }
        }

        document.getElementById('medMitraForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageDiv = document.getElementById('message');
            const qrContainer = document.getElementById('qr-container');
            const qrCodeDiv = document.getElementById('qrcode');
            const statusText = document.getElementById('status-text');
            messageDiv.classList.add('hidden');
            qrContainer.classList.add('hidden');
            qrCodeDiv.innerHTML = '';
            if (pollingInterval) clearInterval(pollingInterval);
            const opdNo = document.getElementById('opdNo').value;
            const therapies = [];
            const rows = document.getElementById('therapyTable').getElementsByTagName('tbody')[0].rows;
            for (let i = 0; i < rows.length; i++) {
                const inputs = rows[i].getElementsByTagName('input');
                therapies.push({ drug: inputs[0].value, dose: inputs[1].value, scheduleTimes: inputs[2].value.split(',').map(t => t.trim()), endDate: inputs[3].value });
            }
            const data = { opdNo, patientName: document.getElementById('patientName').value, contactNumber: document.getElementById('contactNumber').value, complaint: document.getElementById('complaint').value, complaintCode: document.getElementById('complaintCode').value, diagnosis: document.getElementById('diagnosis').value, diagnosisCode: document.getElementById('diagnosisCode').value, language: document.getElementById('language').value, therapies };
            try {
                const res = await fetch(`${CONFIG.API_BASE_URL}/api/medmitra/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (res.ok) {
                    qrContainer.classList.remove('hidden');
                    new QRCode(qrCodeDiv, { text: `https://t.me/${botUsername}?start=${opdNo}`, width: 180, height: 180 });
                    pollingInterval = setInterval(async () => {
                        const check = await fetch(`${CONFIG.API_BASE_URL}/api/medmitra/check-consent/${encodeURIComponent(opdNo)}`);
                        const checkData = await check.json();
                        if (checkData.consent) {
                            clearInterval(pollingInterval);
                            statusText.innerHTML = "‚úÖ Consent Verified!";
                            statusText.className = "px-4 py-2 rounded-full bg-green-100 text-green-700 font-bold";
                            document.getElementById('medMitraForm').reset();
                        }
                    }, 3000);
                }
            } catch (error) { messageDiv.textContent = 'Error: ' + error.message; messageDiv.classList.remove('hidden'); }
        });
        addTherapyRow();
    </script>
</body>
</html>